{% extends "manage/layout.html" %}
<!-- css -->
{% block css %}
<link rel="stylesheet" href="{{manage_assets}}/markdown/css/editormd.min.css" />
<link href="{{manage_assets}}/css/plugins/dropzone/basic.css" rel="stylesheet">
<link href="{{manage_assets}}/css/plugins/dropzone/dropzone.css" rel="stylesheet"> {% endblock %}
<!-- css end-->
<!-- body-->
{% block body %}

<div class="wrapper wrapper-content animated">
  <form id="form-post-upsert" action="/manage/api/post" method="post" novalidate="novalidate">
    <div class="row">
      <div class="col-lg-12">
        <div class="btn-group pull-right">
          <p>
            <a href="/manage/post" class="btn btn-sm btn-default">
              <i class="fa fa-reply"></i>
            </a>
            <button type="submit" class="btn btn-sm btn-primary">
              <i class="fa fa-save"></i>
            </button>
            <!-- ko if: id -->
            <!-- ko if: status()==0 -->
            <button type="button" id="publish" class="btn btn-sm btn-info">
              <i class="fa fa-gavel"></i>
            </button>
            <!-- /ko -->
            <button type="button" class="btn btn-sm btn-danger" data-bind="click:destroy">
              <i class="fa fa-trash"></i>
            </button>
            <!-- /ko -->
          </p>
        </div>
      </div>
    </div>
    <input id="id" name="id" type="text" class="hidden" data-bind="value: id">
    <div class="row">
      <div class="col-lg-6">
        <div class="form-group">
          <label>标题：</label>
          <input name="title" type="text" class="form-control" data-bind="value: title">
        </div>
      </div>
      <div class="col-lg-6">
        <div class="form-group">
          <label>精选:</label>
          <select data-placeholder="" class="chosen-select" data-bind="value: featured" tabindex="2">
            <option value="0">否</option>
            <option value="1">是</option>
          </select>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-6">
        <div class="form-group ">
          <label>图片:</label>
          <a data-toggle="modal" data-target="#model-image-upload">
            <img class="form-control img-preview img-preview-post" data-bind="attr:{src:image()?image:'{{manage_assets}}/images/img_404.png'}"
            />
          </a>
          <input name="image" type="text" class="hidden" data-bind="value: image">
        </div>
      </div>
      <div class="col-lg-6">
        <div class="form-group">
          <label>标签</label>
          <div class="input-group">
            <select name="tags" data-placeholder=" " class="chosen-select form-control" data-bind="options: tagList,optionsText: 'name',optionsValue: 'id', selectedOptions: tags"
              multiple="multiple" tabindex="4"></select>
            <span class="input-group-btn">
              <a href="#modal-tag-create" data-toggle="modal" class="btn btn-primary">
                <i class="fa fa-plus"></i>
              </a>
            </span>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-6">
        <div class="form-group">
          <label>url:</label>
          <input name="slug" type="text" class="form-control" data-bind="value:slug">
        </div>
        <div class="form-group">
          <label>meta_title：</label>
          <input name="meta_title" type="text" class="form-control" data-bind="value:meta_title">
        </div>
      </div>
      <div class="col-lg-6">
        <div class="form-group">
          <label>meta_description：</label>
          <textarea class="form-control" name="meta_description" data-bind="text:meta_description"></textarea>
        </div>
      </div>
    </div>
    <div class="row">
      <div id="editormd-post" class="col-lg-12">
        <textarea style="display:none;" data-bind="text:plaintext"></textarea>
      </div>
    </div>

  </form>
</div>

<div class="modal inmodal" id="model-image-upload" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content animated fadeIn">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">
          <span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span>
        </button>
        <i class="fa fa-picture-o modal-icon"></i>
        <h4 class="modal-title">附件上传</h4>
      </div>
      <div class="modal-body">
        <form class="dropzone" id="dropzoneForm">
          <div class="fallback">
            <input name="file" type="file" multiple />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- add tag view -->
<div id="modal-tag-create" class="modal inmodal" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content animated ">
      <form id="form-tag-create" action="/manage/api/tag" method="post" novalidate="novalidate">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="blue bigger">新增标签</h4>
        </div>
        <div class="modal-body overflow-visible">
          <div class="ibox-content">
            <div class="form-group">
              <label>标签</label>
              <input name="name" type="text" class="form-control">
            </div>
            <div class="form-group">
              <label>描述</label>
              <input name="description" type="text" class="form-control">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-sm" data-dismiss="modal">
            <i class="icon-remove"></i>取消</button>
          <button type="submit" class="btn btn-sm btn-primary">
            <i class="icon-ok"></i>确认</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
<!-- body end-->
<!-- js -->
{% block script %}
<script type="text/javascript" src="{{manage_assets}}/markdown/editormd.min.js"></script>
<script src="{{manage_assets}}/js/plugins/dropzone/dropzone.js"></script>
<script>
  $(".chosen-select").chosen({ width: "100%" });
  var postModel = {
    destroy: function () {
      var post_id = this.id();
      $.ajax({
        url: "/manage/api/post/" + post_id,
        method: "delete",
        dataType: "json",
        success: function (res) {
          if (res.code == 200) {
            swal({
              title: "success",
              text: res.msg,
              type: "success"
            },
              function (isConfirm) {
                window.location.href = "/manage/post";
              });
          } else {
            toastr.error(res.msg);
          }
        },
      });
    },
    id: ko.observable(null),
    slug: ko.observable(null),
    title: ko.observable(null),
    plaintext: ko.observable(null),
    mobiledoc: ko.observable(null),
    html: ko.observable(null),
    featured: ko.observable(null),
    image: ko.observable(null),
    status: ko.observable(0),
    meta_title: ko.observable(null),
    meta_description: ko.observable(null),
    author_id: ko.observable(null),
    created_by: ko.observable(null),
    updated_by: ko.observable(null),
    published_at: ko.observable(null),
    published_by: ko.observable(null),
    created_at: ko.observable(null),
    updated_at: ko.observable(null),
    deleted_at: ko.observable(null),
    tags: ko.observableArray(null),
    tagList: ko.observableArray(null),
    init: function (post) {
      this.id(post.id);
      this.slug(post.slug);
      this.title(post.title);
      this.plaintext(post.plaintext);
      this.mobiledoc(post.mobiledoc);
      this.html(post.html);
      this.featured(post.featured);
      this.image(post.image);
      this.status(post.status);
      this.meta_title(post.meta_title);
      this.meta_description(post.meta_description);
      this.author_id(post.author_id);
      this.created_by(post.created_by);
      this.updated_by(post.updated_by);
      this.published_at(post.published_at);
      this.published_at(post.published_at);
      this.published_by(post.published_by);
      this.created_at(post.created_at);
      this.updated_at(post.updated_at);
      this.deleted_at(post.deleted_at);
      var tags = new Array;
      for (var index in post.tags) {
        tags.push(post.tags[index].id);
      }
      this.tags(tags);
    }
  };
  var tag_load = function (tags) {
    $.ajax({
      url: "/manage/api/tag",
      method: "get",
      dataType: "json",
      success: function (res) {
        if (res.code == 200) {
          postModel.tagList(res.data);
          postModel.tags(tags);
          $(".chosen-select").trigger("chosen:updated");
        } else {
          toastr.error(res.msg);
        }
      },
    });
  }
  tag_load();
  ko.applyBindings(postModel, document.getElementById("form-post-upsert"));
  var locationArray = location.pathname.split('/');
  var editormdPost = editormd("editormd-post", {
    width: "100%",
    height: 640,
    saveHTMLToTextarea: true,
    path: '{{manage_assets}}/markdown/lib/',
    imageUpload: true,
    imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
    imageUploadURL: "/manage/api/image?_csrf={{ ctx.csrf | safe }}",
    onfullscreen: function () {
      if (!$("body").hasClass("mini-navbar")) {
        $("body").toggleClass("mini-navbar");
        SmoothlyMenu();
      }
    },
    onfullscreenExit: function () {
      if ($("body").hasClass("mini-navbar")) {
        $("body").toggleClass("mini-navbar");
        SmoothlyMenu();
      }
    }
  });
  Dropzone.options.dropzoneForm = {
    paramName: "image",
    maxFilesize: 3,
    url: "/manage/api/image?_csrf={{ ctx.csrf | safe }}",
    acceptedFiles: "image/*",
    dictDefaultMessage: "<div class='row'><img class='img-preview' src='{{manage_assets}}/images/img_404.png'/><div>",
    complete: function (file) {
      this.removeFile(file);
      $('#model-image-upload').modal("hide");
      if (file.xhr) {
        var res = JSON.parse(file.xhr.response)
        if (file.xhr.status != 200) {
          toastr.error(res.msg || res.message);
        } else {
          postModel.image(res.url);
        }
      }
    }
  };
  $.ajax({
    url: "/manage/api/post/" + locationArray[locationArray.length - 1],
    method: "get",
    dataType: "json",
    success: function (res) {
      if (res.code == 200) {
        postModel.init(res.data);
        $(".chosen-select").trigger("chosen:updated");
      } else {
        if (res.code = 404) {
          // postModel.init(res.data);
          $(".chosen-select").trigger("chosen:updated");
        } else {
          toastr.error(res.msg);
        }
      }
    },
  });
  jQuery(function ($) {
    $("#form-post-upsert").validate({
      rules: {
        title: {
          required: true,
        },
        slug: {
          remote: '/api/post/slug?id=' + locationArray[locationArray.length - 1],
        },
      },
      submitHandler: function (form) {
        $.ajax({
          url: $(form)[0].action,
          method: $(form)[0].method,
          dataType: "json",
          data: $(form).serialize(),
          success: function (data) {
            if (data.code == 200) {
              swal({
                title: "success",
                text: data.msg,
                type: "success"
              },
                function (isConfirm) {
                  window.location.href = '/manage/post/upsert/' + data.data;
                });
            } else {
              toastr.error(data.msg);
            }
          }
        });
      }
    });
    $("#form-tag-create").validate({
      rules: {
        name: {
          required: true,
        },
      },
      submitHandler: function (form) {
        $.ajax({
          url: $(form)[0].action,
          method: $(form)[0].method,
          dataType: "json",
          data: $(form).serialize(),
          success: function (data) {
            if (data.code == 200) {
              toastr.success(data.msg);
              $("#form-tag-create").find(":input").not(":button,:submit,:reset,:checkbox").val("");
              $("#modal-tag-create").modal("hide");
              var tags = postModel.tags() || new Array;
              tags.push(data.data.id);
              tag_load(tags);
            } else {
              toastr.error(data.msg);
            }
          }
        })
      }
    });
  });
</script> {% endblock %}
<!-- js end-->